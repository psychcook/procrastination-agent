{% extends "base.html" %}

{% block title %}Pre-Fragebogen - Prokrastinations-Agent{% endblock %}

{% block content %}
<div class="questionnaire-container">
    <div class="questionnaire-card">
        <div class="questionnaire-header">
            <h2 class="questionnaire-title">Fragebogen (Vorher)</h2>
            <p class="questionnaire-subtitle">
                Bitte beantworte die folgenden Fragen ehrlich. Es gibt keine richtigen oder falschen Antworten.
            </p>

            <div class="info-box" style="margin-bottom: 24px; font-size: 14px;">
                <strong>Hinweis:</strong> Die Skala reicht von 1 (Ich stimme nicht zu) bis 5 (Ich stimme zu).
            </div>
        </div>

        <form id="preQuestionnaireForm" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            {% for question in questions %}
            <div class="question-block">
                <div class="question-number">Frage {{ loop.index }} von {{ questions|length }}</div>
                <div class="question-text">{{ question.text }}</div>
                <div class="scale-container">
                    <div class="scale-label">{{ question.left_label }}</div>
                    <div class="scale-options">
                        {% for value in range(1, question.scale_max + 1) %}
                        <div class="scale-option" data-question="{{ question.id }}" data-value="{{ value }}">
                            {{ value }}
                        </div>
                        {% endfor %}
                    </div>
                    <div class="scale-label right">{{ question.right_label }}</div>
                </div>
                <input type="hidden" name="q{{ question.id }}" id="q{{ question.id }}" required>
            </div>
            {% endfor %}

            <div class="questionnaire-footer">
                <div class="progress-text">
                    <strong><span id="answeredCount">0</span> von {{ questions|length }}</strong> Fragen beantwortet
                </div>
                <button type="submit" class="primary-btn" id="submitBtn" disabled>
                    Weiter zum Gespräch →
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const answers = {};
    const totalQuestions = {{ questions|length }};

    // Handle scale option clicks
    document.querySelectorAll('.scale-option').forEach(option => {
        option.addEventListener('click', function() {
            const questionId = this.dataset.question;
            const value = this.dataset.value;

            // Remove selected class from siblings
            const siblings = this.parentElement.querySelectorAll('.scale-option');
            siblings.forEach(sib => sib.classList.remove('selected'));

            // Add selected class to clicked option
            this.classList.add('selected');

            // Store answer
            answers[questionId] = value;
            document.getElementById(`q${questionId}`).value = value;

            // Update progress
            updateProgress();
        });
    });

    function updateProgress() {
        const answeredCount = Object.keys(answers).length;
        document.getElementById('answeredCount').textContent = answeredCount;

        // Enable submit button when all questions answered
        const submitBtn = document.getElementById('submitBtn');
        if (answeredCount === totalQuestions) {
            submitBtn.disabled = false;
        } else {
            submitBtn.disabled = true;
        }
    }

    // Handle form submission
    document.getElementById('preQuestionnaireForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = {};
        for (let [key, value] of formData.entries()) {
            if (key !== 'csrf_token') {  // Skip CSRF token in data
                data[key] = parseInt(value);
            }
        }

        try {
            const csrfToken = document.querySelector('input[name="csrf_token"]').value;
            const response = await fetch('/api/save-pre-questionnaire', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                window.location.href = '/chat';
            } else {
                alert('Fehler beim Speichern. Bitte versuche es erneut.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Fehler beim Speichern. Bitte versuche es erneut.');
        }
    });
</script>
{% endblock %}
